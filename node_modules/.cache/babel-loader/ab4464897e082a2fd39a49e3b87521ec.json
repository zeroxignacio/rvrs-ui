{"ast":null,"code":"\"use strict\";\n\nimport { getAddress } from \"@ethersproject/address\";\nimport { BigNumber } from \"@ethersproject/bignumber\";\nimport { arrayify, hexDataSlice, hexlify, hexZeroPad, isBytesLike, splitSignature, stripZeros } from \"@ethersproject/bytes\";\nimport { Zero } from \"@ethersproject/constants\";\nimport { keccak256 } from \"@ethersproject/keccak256\";\nimport { checkProperties } from \"@ethersproject/properties\";\nimport * as RLP from \"@ethersproject/rlp\";\nimport { computePublicKey, recoverPublicKey } from \"@ethersproject/signing-key\";\nimport { Logger } from \"@ethersproject/logger\";\nimport { version } from \"./_version\";\nvar logger = new Logger(version); ///////////////////////////////\n\nfunction handleAddress(value) {\n  if (value === \"0x\") {\n    return null;\n  }\n\n  return getAddress(value);\n}\n\nfunction handleNumber(value) {\n  if (value === \"0x\") {\n    return Zero;\n  }\n\n  return BigNumber.from(value);\n}\n\nvar transactionFields = [{\n  name: \"nonce\",\n  maxLength: 32,\n  numeric: true\n}, {\n  name: \"gasPrice\",\n  maxLength: 32,\n  numeric: true\n}, {\n  name: \"gasLimit\",\n  maxLength: 32,\n  numeric: true\n}, {\n  name: \"to\",\n  length: 20\n}, {\n  name: \"value\",\n  maxLength: 32,\n  numeric: true\n}, {\n  name: \"data\"\n}];\nvar allowedTransactionKeys = {\n  chainId: true,\n  data: true,\n  gasLimit: true,\n  gasPrice: true,\n  nonce: true,\n  to: true,\n  value: true\n};\nexport function computeAddress(key) {\n  var publicKey = computePublicKey(key);\n  return getAddress(hexDataSlice(keccak256(hexDataSlice(publicKey, 1)), 12));\n}\nexport function recoverAddress(digest, signature) {\n  return computeAddress(recoverPublicKey(arrayify(digest), signature));\n}\nexport function serialize(transaction, signature) {\n  checkProperties(transaction, allowedTransactionKeys);\n  var raw = [];\n  transactionFields.forEach(function (fieldInfo) {\n    var value = transaction[fieldInfo.name] || [];\n    var options = {};\n\n    if (fieldInfo.numeric) {\n      options.hexPad = \"left\";\n    }\n\n    value = arrayify(hexlify(value, options)); // Fixed-width field\n\n    if (fieldInfo.length && value.length !== fieldInfo.length && value.length > 0) {\n      logger.throwArgumentError(\"invalid length for \" + fieldInfo.name, \"transaction:\" + fieldInfo.name, value);\n    } // Variable-width (with a maximum)\n\n\n    if (fieldInfo.maxLength) {\n      value = stripZeros(value);\n\n      if (value.length > fieldInfo.maxLength) {\n        logger.throwArgumentError(\"invalid length for \" + fieldInfo.name, \"transaction:\" + fieldInfo.name, value);\n      }\n    }\n\n    raw.push(hexlify(value));\n  });\n  var chainId = 0;\n\n  if (transaction.chainId != null) {\n    // A chainId was provided; if non-zero we'll use EIP-155\n    chainId = transaction.chainId;\n\n    if (typeof chainId !== \"number\") {\n      logger.throwArgumentError(\"invalid transaction.chainId\", \"transaction\", transaction);\n    }\n  } else if (signature && !isBytesLike(signature) && signature.v > 28) {\n    // No chainId provided, but the signature is signing with EIP-155; derive chainId\n    chainId = Math.floor((signature.v - 35) / 2);\n  } // We have an EIP-155 transaction (chainId was specified and non-zero)\n\n\n  if (chainId !== 0) {\n    raw.push(hexlify(chainId)); // @TODO: hexValue?\n\n    raw.push(\"0x\");\n    raw.push(\"0x\");\n  } // Requesting an unsigned transation\n\n\n  if (!signature) {\n    return RLP.encode(raw);\n  } // The splitSignature will ensure the transaction has a recoveryParam in the\n  // case that the signTransaction function only adds a v.\n\n\n  var sig = splitSignature(signature); // We pushed a chainId and null r, s on for hashing only; remove those\n\n  var v = 27 + sig.recoveryParam;\n\n  if (chainId !== 0) {\n    raw.pop();\n    raw.pop();\n    raw.pop();\n    v += chainId * 2 + 8; // If an EIP-155 v (directly or indirectly; maybe _vs) was provided, check it!\n\n    if (sig.v > 28 && sig.v !== v) {\n      logger.throwArgumentError(\"transaction.chainId/signature.v mismatch\", \"signature\", signature);\n    }\n  } else if (sig.v !== v) {\n    logger.throwArgumentError(\"transaction.chainId/signature.v mismatch\", \"signature\", signature);\n  }\n\n  raw.push(hexlify(v));\n  raw.push(stripZeros(arrayify(sig.r)));\n  raw.push(stripZeros(arrayify(sig.s)));\n  return RLP.encode(raw);\n}\nexport function parse(rawTransaction) {\n  var transaction = RLP.decode(rawTransaction);\n\n  if (transaction.length !== 9 && transaction.length !== 6) {\n    logger.throwArgumentError(\"invalid raw transaction\", \"rawTransaction\", rawTransaction);\n  }\n\n  var tx = {\n    nonce: handleNumber(transaction[0]).toNumber(),\n    gasPrice: handleNumber(transaction[1]),\n    gasLimit: handleNumber(transaction[2]),\n    to: handleAddress(transaction[3]),\n    value: handleNumber(transaction[4]),\n    data: transaction[5],\n    chainId: 0\n  }; // Legacy unsigned transaction\n\n  if (transaction.length === 6) {\n    return tx;\n  }\n\n  try {\n    tx.v = BigNumber.from(transaction[6]).toNumber();\n  } catch (error) {\n    console.log(error);\n    return tx;\n  }\n\n  tx.r = hexZeroPad(transaction[7], 32);\n  tx.s = hexZeroPad(transaction[8], 32);\n\n  if (BigNumber.from(tx.r).isZero() && BigNumber.from(tx.s).isZero()) {\n    // EIP-155 unsigned transaction\n    tx.chainId = tx.v;\n    tx.v = 0;\n  } else {\n    // Signed Tranasaction\n    tx.chainId = Math.floor((tx.v - 35) / 2);\n\n    if (tx.chainId < 0) {\n      tx.chainId = 0;\n    }\n\n    var recoveryParam = tx.v - 27;\n    var raw = transaction.slice(0, 6);\n\n    if (tx.chainId !== 0) {\n      raw.push(hexlify(tx.chainId));\n      raw.push(\"0x\");\n      raw.push(\"0x\");\n      recoveryParam -= tx.chainId * 2 + 8;\n    }\n\n    var digest = keccak256(RLP.encode(raw));\n\n    try {\n      tx.from = recoverAddress(digest, {\n        r: hexlify(tx.r),\n        s: hexlify(tx.s),\n        recoveryParam: recoveryParam\n      });\n    } catch (error) {\n      console.log(error);\n    }\n\n    tx.hash = keccak256(rawTransaction);\n  }\n\n  return tx;\n}","map":{"version":3,"mappings":"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","names":["getAddress","BigNumber","arrayify","hexDataSlice","hexlify","hexZeroPad","isBytesLike","splitSignature","stripZeros","Zero","keccak256","checkProperties","RLP","computePublicKey","recoverPublicKey","Logger","version","logger","handleAddress","value","handleNumber","from","transactionFields","name","maxLength","numeric","length","allowedTransactionKeys","chainId","data","gasLimit","gasPrice","nonce","to","computeAddress","key","publicKey","recoverAddress","digest","signature","serialize","transaction","raw","forEach","fieldInfo","options","hexPad","throwArgumentError","push","v","Math","floor","encode","sig","recoveryParam","pop","r","s","parse","rawTransaction","decode","tx","toNumber","error","console","log","isZero","slice","hash"],"sourceRoot":"","sources":["../src.ts/index.ts"],"sourcesContent":[null]},"metadata":{},"sourceType":"module"}